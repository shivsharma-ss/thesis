<!-- modbus_app/templates/modbus_app/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Modbus Communication</title>
    <style>
        .indicator { width: 20px; height: 20px; border-radius: 50%; display: inline-block; margin-left: 10px; }
        .green { background-color: green; }
        .red { background-color: red; }
        .slider-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .slider-label {
            margin-left: 10px;
        }
        .program-control {
            display: flex;
            align-items: center;
        }
        .program-control input {
            width: 50px;
            text-align: center;
        }
        .program-control button {
            width: 30px;
            height: 30px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(14px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
        .output-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-left: 20px;
        }
        .output-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .output-item span {
            margin-left: 10px;
        }
        .config-section {
            display: flex;
            align-items: center;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    {% load custom_filters %}
    <form id="config-form" method="POST">
        {% csrf_token %}
        <div class="config-section">
            <div>
                <label for="ip_address">IP Address:</label>
                <input type="text" id="ip_address" name="ip_address" value="{{ config.ip_address }}" disabled>
                <button type="button" id="edit-ip-btn">Change IP</button><br>
                <label for="port">Port:</label>
                <input type="text" id="port" name="port" value="{{ config.port }}" disabled>
                <button type="button" id="edit-port-btn">Change Port</button><br>

                <div class="slider-container">
                    <label class="switch">
                        <input type="checkbox" id="enable" name="enable" {% if signals.enable %}checked{% endif %} onchange="updateWrittenBits()">
                        <span class="slider round"></span>
                    </label>
                    <label class="slider-label" for="enable">Enable</label>
                </div>

                <div class="slider-container">
                    <label class="switch">
                        <input type="checkbox" id="clockwise" name="clockwise" {% if signals.clockwise %}checked{% endif %} onchange="updateWrittenBits()">
                        <span class="slider round"></span>
                    </label>
                    <label class="slider-label" for="clockwise">CW</label>
                </div>

                <div class="slider-container">
                    <label class="switch">
                        <input type="checkbox" id="counter_clockwise" name="counter_clockwise" {% if signals.counter_clockwise %}checked{% endif %} onchange="updateWrittenBits()">
                        <span class="slider round"></span>
                    </label>
                    <label class="slider-label" for="counter_clockwise">CCW</label>
                </div>

                <div class="slider-container">
                    <label class="switch">
                        <input type="checkbox" id="ready" name="ready" {% if signals.ready %}checked{% endif %} onchange="updateWrittenBits()">
                        <span class="slider round"></span>
                    </label>
                    <label class="slider-label" for="ready">ResF</label>
                </div>

                <div class="slider-container">
                    <label class="switch">
                        <input type="checkbox" id="ok" name="ok" {% if signals.ok %}checked{% endif %} onchange="updateWrittenBits()">
                        <span class="slider round"></span>
                    </label>
                    <label class="slider-label" for="ok">ResRs</label>
                </div>

                <label>Program Number:</label>
                <div class="program-control">
                    <button type="button" onclick="changeProgramNumber(-1)">&#9660;</button>
                    <input type="number" id="program_number" name="program_number" value="{{ signals.program_number }}" min="0" max="255" oninput="updateWrittenBits()">
                    <button type="button" onclick="changeProgramNumber(1)">&#9650;</button>
                </div><br>
            </div>

            <div class="output-section">
                <div class="output-item">
                    <span class="indicator {% if signals.ready %}green{% else %}red{% endif %}" id="ready-indicator"></span>
                    <span>Ready</span>
                </div>
                <div class="output-item">
                    <span class="indicator {% if signals.nok %}green{% else %}red{% endif %}" id="nok-indicator"></span>
                    <span>NF</span>
                </div>
                <div class="output-item">
                    <span class="indicator {% if signals.cycle_complete %}green{% else %}red{% endif %}" id="cycle-complete-indicator
                    "></span>
                    <span>Cycle Complete</span>
                </div>
                <div class="output-item">
                    <span class="indicator {% if signals.ok %}green{% else %}red{% endif %}" id="ok-indicator"></span>
                    <span>OK</span>
                </div>
                <div class="output-item">
                    <span class="indicator {% if signals.in_cycle %}green{% else %}red{% endif %}" id="in-cycle-indicator"></span>
                    <span>In Cycle</span>
                </div>
            </div>
        </div>

        <button type="submit" formaction="{% url 'update_signals' %}">Update Signals</button>
        <button type="button" id="send-signal-btn">Send Signal</button>
    </form>

    <br>
    <label>Received Bits:</label>
    <textarea id="received_bits" readonly>{{ received_bits }}</textarea><br>
    <label>Bits to be Written:</label>
    <textarea id="written_bits" readonly>{{ written_bits }}</textarea><br>

    <script>
        function updateWrittenBits() {
            const formData = $('#config-form').serializeArray();
            let bits = Array(16).fill(0);

            formData.forEach(item => {
                if (item.name === 'program_number') {
                    let programBits = parseInt(item.value).toString(2).padStart(8, '0').split('').map(Number);
                    for (let i = 0; i < programBits.length; i++) {
                        bits[8 + i] = programBits[i];
                    }
                } else {
                    bits[{
                        enable: 0,
                        clockwise: 1,
                        counter_clockwise: 2,
                        ready: 3,
                        ok: 4
                    }[item.name]] = item.value === 'true' || item.value === 'on' ? 1 : 0;
                }
            });

            $('#written_bits').val(bits.join(''));
        }

        function changeProgramNumber(delta) {
            let currentValue = parseInt($('#program_number').val());
            let newValue = currentValue + delta;
            if (newValue >= 0 && newValue <= 255) {
                $('#program_number').val(newValue);
                updateWrittenBits();
            }
        }

        $('#send-signal-btn').click(function() {
            $.ajax({
                type: 'POST',
                url: "{% url 'send_signal' %}",
                data: $('#config-form').serialize(),
                success: function(response) {
                    alert('Signal sent successfully.');
                },
                error: function() {
                    alert('Failed to send signal.');
                }
            });
        });

        $('#edit-ip-btn').click(function() {
            $('#ip_address').prop('disabled', false);
        });

        $('#edit-port-btn').click(function() {
            $('#port').prop('disabled', false);
        });

        $('#config-form').submit(function(event) {
            event.preventDefault();
            $.ajax({
                type: 'POST',
                url: "{% url 'update_signals' %}",
                data: $(this).serialize(),
                success: function(response) {
                    $('#received_bits').val(response.received_bits);
                    updateIndicators(response.received_bits);
                },
                error: function() {
                    alert('Failed to update signals.');
                }
            });
        });

        function updateIndicators(bits) {
            const bitArray = bits.split('');
            document.getElementById('ready-indicator').className = bitArray[3] == '1' ? 'indicator green' : 'indicator red';
            document.getElementById('nok-indicator').className = bitArray[5] == '1' ? 'indicator green' : 'indicator red';
            document.getElementById('cycle-complete-indicator').className = bitArray[7] == '1' ? 'indicator green' : 'indicator red';
            document.getElementById('ok-indicator').className = bitArray[4] == '1' ? 'indicator green' : 'indicator red';
            document.getElementById('in-cycle-indicator').className = bitArray[6] == '1' ? 'indicator green' : 'indicator red';
        }
    </script>
</body>
</html>
